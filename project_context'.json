{
  "project": {
    "name": "WorldEdit — AI-Powered 3D Scene Editor",
    "version": "1.0.0",
    "description": "A web-based 3D world editor that ingests World Labs Gaussian Splat PLY files, renders them in-browser, enables navigation and selection via lasso and natural language, then uses AI to modify and animate scene elements. Animated and added assets are exported as GLB for use in Unity and other engines.",
    "status": "pre-production",
    "target_users": [
      "3D world creators using World Labs",
      "Game developers needing scene dressing",
      "Spatial computing designers",
      "Virtual production teams"
    ]
  },

  "core_concepts": {
    "input_format": {
      "type": "PLY",
      "subtype": "3D Gaussian Splatting",
      "source": "World Labs",
      "description": "Gaussian Splat PLY files represent scenes as millions of 3D Gaussian primitives, each with position, rotation, scale, opacity, and spherical harmonic color coefficients. This is fundamentally different from mesh PLY — no vertices, edges, or faces.",
      "file_size_range": "200MB – 1GB+",
      "compression_target": "KSPLAT format via server-side conversion (~4:1 ratio)"
    },
    "output_formats": {
      "primary": "GLB (GLTF Binary)",
      "use_cases": [
        "Unity import",
        "Unreal Engine import",
        "Blender import",
        "Any GLTF-compatible engine"
      ],
      "contents": [
        "Environment mesh (baked from Gaussians via SuGaR)",
        "Added 3D objects with PBR materials",
        "Baked animation clips (AnimationClip keyframes)",
        "Embedded textures"
      ]
    },
    "rendering_model": {
      "type": "Hybrid",
      "description": "Gaussian splats render the environment background. GLB mesh objects (AI-generated additions) are overlaid in the same Three.js scene graph. Post-processing effects are applied as a unified pass over both layers."
    }
  },

  "architecture": {
    "frontend": {
      "framework": "React + Vite",
      "deployment": "Vercel or Netlify",
      "renderer": {
        "library": "GaussianSplats3D (@mkkellogg/GaussianSplats3D)",
        "base": "Three.js",
        "format_support": ["PLY", "SPLAT", "KSPLAT"],
        "target_fps": 60,
        "splat_limit": "~1M splats at 60fps",
        "progressive_loading": true
      },
      "scene_graph": "Three.js",
      "asset_loader": "Three.js GLTFLoader",
      "export": "Three.js GLTFExporter (browser-side, no server required)"
    },
    "backend": {
      "infrastructure": "Modal (GPU serverless)",
      "pattern": "Async job queue — user queues heavy edits, gets notified on completion, lightweight operations return synchronously",
      "storage": "Cloudflare R2 (large PLY/GLB files) + S3-compatible API",
      "file_delivery": "Chunked streaming for large PLY files"
    }
  },

  "layers": {
    "layer_1_rendering": {
      "name": "PLY Ingestion & Rendering",
      "description": "User uploads a World Labs PLY file. It is optionally compressed to KSPLAT server-side on Modal, then streamed progressively to the browser renderer.",
      "components": [
        "File upload UI with drag-and-drop",
        "Server-side PLY → KSPLAT converter (Modal endpoint)",
        "Progressive loader with loading progress indicator",
        "GaussianSplats3D renderer in Three.js canvas"
      ],
      "performance_notes": "Files over 200MB should be converted to KSPLAT before delivery. Progressive loading allows first-frame render within seconds while remainder streams."
    },

    "layer_2_navigation": {
      "name": "Scene Navigation",
      "description": "Free-fly first-person navigation through the Gaussian splat scene.",
      "camera_modes": [
        "Orbit (default, click+drag around a point)",
        "Fly / FPS (WASD + mouse look via PointerLockControls)",
        "Cinematic (smooth interpolated path between bookmarked positions)"
      ],
      "collision_note": "Gaussian splats have no collision geometry. Ground plane is estimated from the statistical floor of the splat point distribution. Users navigate in free-fly mode with optional ground-lock toggle.",
      "three_js_controls": ["PointerLockControls", "FlyControls", "OrbitControls"]
    },

    "layer_3_selection": {
      "name": "Element Selection",
      "modes": {
        "lasso": {
          "description": "User draws a freehand polygon on screen. All Gaussian splats whose projected 2D screen positions fall within the polygon are selected.",
          "implementation": [
            "Render splat world positions to a pick buffer texture",
            "On lasso close, run point-in-polygon test against each splat's projected screen coordinate",
            "Tag selected splats with a semantic region ID",
            "Highlight selected region with a color overlay shader",
            "Return selected Gaussian subset as Region of Interest (ROI)"
          ],
          "performance": "Spatial octree index on CPU side to test only visible splats"
        },
        "natural_language": {
          "description": "User types a plain English description of what they want to select (e.g. 'the trees', 'the couch', 'all the windows').",
          "pipeline": [
            "Render 6–12 camera viewpoints of the current scene",
            "Send renders to Modal endpoint running Grounding DINO (text → bounding boxes)",
            "Pass bounding boxes to SAM 2 (boxes → pixel-precise masks)",
            "Back-project 2D masks into 3D to identify corresponding Gaussian splats",
            "Return splats as NL-selected ROI"
          ],
          "models_used": ["Grounding DINO (Apache 2.0)", "SAM 2 (Apache 2.0)"],
          "modal_gpu": "A10G"
        }
      },
      "roi_output": {
        "description": "A Region of Interest (ROI) is the output of any selection operation — a tagged subset of Gaussian splat indices with a semantic label. ROIs are passed to all downstream modification layers."
      }
    },

    "layer_4_nl_intent": {
      "name": "Natural Language Intent Parser",
      "description": "All user text commands are routed through an LLM hosted on Modal. The LLM classifies intent and returns a structured action JSON that is dispatched to the appropriate modification pipeline.",
      "model": "Llama 3.1 8B Instruct via vLLM",
      "modal_gpu": "A10G",
      "output_schema": {
        "action": "animate | edit_appearance | insert_object | select | deselect | export | adjust_environment",
        "target": "string (object label or ROI id)",
        "effect": "string (sway, ripple, flicker, sit, walk, etc.)",
        "params": "object (effect-specific parameters)",
        "async": "boolean (true for long-running jobs like GaussianEditor)"
      },
      "example_input": "make the trees sway gently in the wind",
      "example_output": {
        "action": "animate",
        "target": "trees",
        "effect": "sway",
        "params": {
          "amplitude": 0.05,
          "frequency": 0.8,
          "axis": "xz",
          "phase_variation": true,
          "turbulence": 0.2
        },
        "async": false
      }
    },

    "layer_5_modifications": {
      "name": "Scene Modification Pipelines",
      "pipelines": {
        "procedural_animation": {
          "description": "Real-time GPU shader-based animation applied to tagged Gaussian splat regions. Runs entirely in the browser, zero latency, no server round-trip.",
          "effects": {
            "sway": {
              "use_case": "Trees, grass, hanging objects, curtains",
              "implementation": "Sinusoidal XZ displacement with per-splat phase offset based on world-space X position. Secondary high-frequency micro-flutter layer.",
              "params": ["amplitude", "frequency", "windDirection", "turbulence", "gustFrequency"]
            },
            "ripple": {
              "use_case": "Water surfaces, puddles, fabric",
              "implementation": "Gerstner wave model — sum of multiple sine waves at different angles and frequencies displacing Gaussian XY positions. Specular highlight flash on crests.",
              "params": ["waveHeight", "waveFrequency", "waveDirection", "waveCount", "specularIntensity"]
            },
            "flicker": {
              "use_case": "Lamps, fire, screens, candles",
              "implementation": "Perlin noise-driven emissive intensity modulation on light-source Gaussians. Formula: base + amplitude * noise(time * speed)",
              "params": ["baseIntensity", "flickerAmplitude", "flickerSpeed", "colorTemperatureShift"]
            },
            "pulse": {
              "use_case": "Glowing objects, energy fields, neon signs",
              "implementation": "Smooth sinusoidal opacity and scale oscillation on selected splats.",
              "params": ["pulseRate", "minOpacity", "maxOpacity", "scaleVariation"]
            },
            "drift": {
              "use_case": "Smoke, fog, floating particles",
              "implementation": "Slow stochastic Perlin noise path on splat positions with optional gravity component.",
              "params": ["driftSpeed", "driftRadius", "gravity", "fadeDistance"]
            }
          }
        },

        "appearance_editing": {
          "description": "Text-driven modification of the visual appearance of selected Gaussian splats. Uses an iterative 2D edit → 3D re-optimization loop. Long-running async job.",
          "model": "GaussianEditor (MIT) or Instruct-GS2GS (MIT)",
          "underlying_model": "InstructPix2Pix",
          "modal_gpu": "A100",
          "ux_pattern": "User queues edit → receives job ID → poll for completion → updated PLY streamed back and hot-swapped in scene",
          "examples": [
            "make the walls look like exposed brick",
            "change the carpet to dark hardwood",
            "make the scene look like it's on fire",
            "age the building — cracked paint, weathered surfaces"
          ]
        },

        "object_insertion": {
          "description": "Generate a new 3D asset from a text prompt and place it at the selected location in the scene. The asset is a GLB mesh rendered on top of the Gaussian splat environment.",
          "pipeline": [
            "LLM extracts object description and target placement from user prompt",
            "Text → image via FLUX or SDXL (Modal A10G, ~2s)",
            "Image → 3D GLB via TripoSR or InstantMesh (Modal A10G/A100, 0.5–20s)",
            "GLB loaded into Three.js scene via GLTFLoader at target world position",
            "User can translate/rotate/scale the placed object with transform gizmo",
            "Object is registered in scene asset registry for export"
          ],
          "placement_methods": [
            "Lasso defines drop zone (center of selected region)",
            "NL specifies location ('on the couch', 'near the window')",
            "Manual click-to-place after generation"
          ],
          "models": {
            "fast": "TripoSR (MIT) — ~0.5s, good quality",
            "quality": "InstantMesh (Apache 2.0) — ~20s, high quality",
            "best": "Hunyuan3D-2 (open weights) — ~45s, best quality"
          }
        },

        "human_character_insertion": {
          "description": "Generate an animated human character from a text description of their appearance and action, place them in the scene.",
          "pipeline": [
            "Parse character description and motion description from user prompt",
            "Generate motion clip from text via MDM or MotionDiffuse (Modal A10G, ~3–5s)",
            "Motion output (SMPL/BVH) converted to Three.js AnimationClip",
            "Character mesh generated or sourced from library, rigged, and bound to animation",
            "Animated character placed as GLB in scene with looping AnimationClip"
          ],
          "models": {
            "motion_generation": "MDM 50-step variant (MIT) or MotionDiffuse (MIT)",
            "unified": "MotionGPT (MIT) — handles both motion understanding and generation"
          },
          "output": "Animated rigged GLB with baked keyframe animation clips"
        }
      }
    },

    "layer_6_environment": {
      "name": "Dynamic Environment System",
      "description": "Scene-wide environmental effects applied as Three.js post-processing and shader layers composited over the splat render.",
      "systems": {
        "sky_and_lighting": {
          "model": "Preetham sky model (GLSL procedural)",
          "time_of_day": "0.0–1.0 normalized value driving sun arc, ambient color, and sky gradient",
          "light_types": ["directional (sun/moon)", "ambient (sky)", "hemisphere"],
          "color_temperature": "Shifts from 2700K (sunset) to 6500K (midday) to 9000K (dusk/dawn)"
        },
        "post_processing": {
          "pipeline": "Three.js EffectComposer",
          "effects": [
            "SSAO (Screen-Space Ambient Occlusion) — contact shadows in crevices",
            "God Rays (radial blur from light source — screen-space)",
            "Bloom (emissive glow from lights and bright surfaces)",
            "Depth of Field (focus blur for cinematic framing)",
            "Film Grain (optional realism grounding)",
            "Color Grading (LUT-based tone mapping)"
          ]
        },
        "volumetrics": {
          "fog": "Raymarched volumetric fog with Fractal Brownian Motion for natural variation",
          "light_shafts": "Henyey-Greenstein phase function scattering for god rays through windows"
        },
        "particle_systems": {
          "library": "Three.js Points geometry with custom shaders",
          "presets": [
            "Dust motes (slow drift in sunbeam zones)",
            "Fireflies (bioluminescent pulse + Perlin drift path)",
            "Snow (gravity + wind deflection)",
            "Rain (high-velocity streaks + splash splats on surfaces)",
            "Pollen / dandelion seeds (slow float with scale fade)"
          ]
        },
        "weather_system": {
          "description": "LLM-driven weather preset bundles — each weather state is a coordinated set of shader uniforms, particle configs, and audio triggers.",
          "presets": ["clear", "overcast", "light_rain", "heavy_rain", "fog", "snow", "golden_hour", "night"],
          "parameters": ["cloudCover", "rainIntensity", "windSpeed", "windDirection", "fogDensity", "ambientBrightness"]
        },
        "spatial_audio": {
          "api": "Web Audio API with PannerNode",
          "auto_triggers": "Animation effects automatically trigger matching audio presets (sway → wind, ripple → water, flicker → fire crackle)",
          "audio_layers": ["ambient_room_tone", "weather_ambience", "positional_object_audio", "character_footsteps"]
        }
      }
    },

    "layer_7_export": {
      "name": "GLB Export & Playback",
      "description": "Export the composed scene — environment mesh, added objects, and animation clips — as a single GLB file for use in downstream engines.",
      "pipeline": [
        "Environment Gaussians → mesh via SuGaR (Modal A100) → base environment GLB",
        "Added GLB objects collected from scene asset registry",
        "Procedural animations baked to keyframe AnimationClips via Three.js",
        "Human character animations already in keyframe format from MDM output",
        "All assets merged and exported via Three.js GLTFExporter (browser-side)"
      ],
      "playback": {
        "description": "Animation timeline UI for previewing and scrubbing all scene animations before export.",
        "controls": ["play", "pause", "stop", "scrub", "loop_toggle", "speed_multiplier"],
        "per_object_tracks": "Each animated element has its own track in the timeline — can be muted, soloed, or offset in time"
      },
      "compatibility": ["Unity (via GLTF importer)", "Unreal Engine 5", "Blender", "Godot 4", "Three.js", "Babylon.js", "AR/VR runtimes supporting GLTF 2.0"]
    }
  },

  "modal_endpoints": [
    {
      "name": "ply_compress",
      "description": "Convert uploaded PLY to KSPLAT for efficient browser delivery",
      "gpu": "A10G",
      "trigger": "on file upload"
    },
    {
      "name": "nl_select",
      "description": "Grounding DINO + SAM 2 pipeline for NL-driven Gaussian selection",
      "gpu": "A10G",
      "trigger": "on NL selection submit"
    },
    {
      "name": "intent_parse",
      "description": "Llama 3.1 8B via vLLM — parse NL command to structured action JSON",
      "gpu": "A10G",
      "trigger": "on every user text command"
    },
    {
      "name": "generate_asset_fast",
      "description": "FLUX image gen + TripoSR → GLB object generation",
      "gpu": "A10G",
      "trigger": "on object insert (fast mode)"
    },
    {
      "name": "generate_asset_quality",
      "description": "FLUX image gen + InstantMesh → high quality GLB",
      "gpu": "A100",
      "trigger": "on object insert (quality mode)"
    },
    {
      "name": "generate_motion",
      "description": "MDM or MotionDiffuse → SMPL/BVH motion clip",
      "gpu": "A10G",
      "trigger": "on human character insert with motion description"
    },
    {
      "name": "edit_gaussians",
      "description": "GaussianEditor — text-driven appearance edit of selected Gaussian region",
      "gpu": "A100",
      "trigger": "on appearance edit confirm (async job)",
      "async": true
    },
    {
      "name": "extract_mesh",
      "description": "SuGaR — convert Gaussian splat scene to polygon mesh for GLB environment base",
      "gpu": "A100",
      "trigger": "on export initiation (async job)",
      "async": true
    }
  ],

  "data_flow": {
    "ingestion": "User uploads PLY → R2 storage → Modal compress → KSPLAT streamed to browser → GaussianSplats3D renders",
    "selection": "User lasso/NL → ROI (Gaussian index set + semantic label) → stored in scene state",
    "modification": "ROI + user command → intent_parse endpoint → action JSON → dispatched to appropriate pipeline (browser-side shader OR Modal async job)",
    "asset_addition": "User NL → generate_asset endpoint → GLB returned → loaded into Three.js scene at target position → registered in asset_registry",
    "export": "Export trigger → extract_mesh (async) → merge all GLBs + bake animations → GLTFExporter → download link"
  },

  "scene_state_schema": {
    "gaussians": {
      "source_url": "string (R2 URL to KSPLAT file)",
      "regions": "ROI[] (named subsets of Gaussian indices with semantic labels)"
    },
    "asset_registry": {
      "description": "All GLB objects added to the scene",
      "item_schema": {
        "id": "string",
        "label": "string",
        "source_glb_url": "string",
        "world_position": "[x, y, z]",
        "world_rotation": "[x, y, z, w]",
        "world_scale": "[x, y, z]",
        "animations": "string[] (names of animation clips on this asset)"
      }
    },
    "animation_tracks": {
      "description": "All active animations keyed by target ROI or asset ID",
      "item_schema": {
        "target_id": "string (ROI id or asset id)",
        "effect": "string",
        "params": "object",
        "start_time": "number (seconds)",
        "duration": "number (0 = infinite loop)",
        "loop": "boolean"
      }
    },
    "environment_state": {
      "time_of_day": "number (0.0–1.0)",
      "weather_preset": "string",
      "wind_speed": "number",
      "wind_direction": "[x, z]",
      "fog_density": "number",
      "post_processing": "object (per-effect enable flags and params)"
    }
  },

  "build_phases": {
    "phase_1": {
      "name": "Core Viewer",
      "deliverables": ["PLY upload + KSPLAT conversion", "GaussianSplats3D render", "Orbit + fly camera", "Basic UI shell"]
    },
    "phase_2": {
      "name": "Selection System",
      "deliverables": ["Lasso tool with pick buffer", "Splat highlight overlay", "NL selection via Grounding DINO + SAM 2 on Modal", "ROI management panel"]
    },
    "phase_3": {
      "name": "Procedural Animation + Export",
      "deliverables": ["Intent parser on Modal (Llama 3.1 8B)", "Sway / ripple / flicker / pulse effects", "Animation timeline UI", "GLB export via GLTFExporter"]
    },
    "phase_4": {
      "name": "AI Object Insertion",
      "deliverables": ["TripoSR / InstantMesh pipelines on Modal", "GLB overlay rendering", "Transform gizmo for placed objects", "Human character + MDM motion pipeline"]
    },
    "phase_5": {
      "name": "Environment System + Polish",
      "deliverables": ["Sky / day-night cycle", "SSAO + god rays + bloom post-processing", "Particle presets", "Weather system", "Spatial audio", "Gaussian appearance editing (GaussianEditor, async)"]
    }
  }
}
